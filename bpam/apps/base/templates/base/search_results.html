{% extends "base.html" %}
{% block title %}Search Results {% endblock %}
{% block content %}
    {% if search_form %}

        <form  action="" class="form-inline" role="form" method="post">{% csrf_token %}
              <div class="panel panel-default">
                  <div class="panel-heading">Search Form</div>
                  <div class="panel-body">
                      <table id="search_form_table" class="table  table-striped table-condensed">
                          <tbody>
                          {{ search_form.as_table}}
                          </tbody>
                      </table>

                  </div>
              </div>
            <input type="submit" class="btn btn-default" value="Search" />
            <div id="search_selection">
            <input class="form-control" name="search_type" type="radio" id="field" value="field" checked="checked">Field Search</>
            <input class="form-control" name="search_type" type="radio" id="range" value="range">Range Search</>
            </div>
        </form>
        <script>
             function  row(id, visible) {
                 var el = $("#" + id);
                 if (visible) {
                     el.closest("tr").show();
                 }
                 else {
                     el.closest("tr").hide();
                 }
             }

             $(document).ready(function () {
                $("label").addClass("control-label");
                $("td").css({"width": "50%"});
                $(".errorlist").addClass("alert alert-danger");
                $(".alert-danger").removeClass("errorlist");

                var auto_complete_url = "{% url 'base:auto_complete' None  %}".replace("None","");
                var rangeSearchFields = "label[for='id_search_range']," +
                        "#id_search_range," +
                        "label[for='id_search_range_min']," +
                        "#id_search_range_min," +
                        "label[for='id_search_range_max']," +
                        "#id_search_range_max";

                var singleSearchFields = "label[for='id_search_field']," +
                        "#id_search_field," +
                        "label[for='id_search_value'],"+
                        "#id_search_value";

                   function clearRangeFields() {
                    $("#id_search_range").val("");
                    $("#id_search_range_min").val("");
                    $("#id_search_range_max").val("");
                }

                function clearSingleFields() {
                    $("#id_search_field").val("");
                    $("#id_search_value").val("");
                }

                function showRangeSearch() {
                    clearSingleFields();
                    $(singleSearchFields).hide();
                    $(rangeSearchFields).show();
                    row('id_search_range_max', true);
                    row('id_search_range_min', true);
                    row('id_search_range', true);
                    row('id_search_field', false);
                    row('id_search_value', false);
                }

                function showFieldSearch() {
                    clearRangeFields();
                    $(rangeSearchFields).hide();
                    row('id_search_range_max', false);
                    row('id_search_range_min', false);
                    row('id_search_range', false);
                    row('id_search_field', true);
                    row('id_search_value', true);
                    $(singleSearchFields).show();
                }


                function showCorrectSearchFields() {
                    var isSingleSearch = $("#id_search_field").val() != "";
                    if (isSingleSearch) {
                        showFieldSearch();
                        $("#field").prop("checked",true);
                    }
                    else {
                        showRangeSearch();
                        $("#range").prop("checked",true);
                    }
                }

                $("input[name='search_type']").change(function (){
                     var sel = $("input[name='search_type']:checked").val();
                     if (sel == 'field'){
                        showFieldSearch();
                     }
                     else {
                       showRangeSearch();
                     }
                 });

                showCorrectSearchFields();

                $("#id_search_field").change(function () {
                      $(".typeahead").unbind();
                      var standardisedVocabularyOptions = new Bloodhound({
                      datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
                      queryTokenizer: Bloodhound.tokenizers.whitespace,
                      remote: auto_complete_url + $('#id_search_field').val() + "?q=%QUERY"
                     });

                     standardisedVocabularyOptions.initialize();

                     $("#id_search_value").typeahead(null, {
                          name: 'standardised-vocabulary-options',
                          displayKey: 'name',
                          source: standardisedVocabularyOptions.ttAdapter()
                     });

                })
             });

        </script>

    {% endif %}

    {% if request.POST %}
        <div class="panel panel-default">
        <div class="panel-heading">Results</div>
        <div class="panel-body">

        {% if samples %}
            <table id="samples" class="table table-striped tablesorter">
                <thead>
                    <tr>
                        <th>BPA ID</th>
                        <th>Sample Context</th>
                        <th>Chemical Analysis</th>

    </tr>
    </thead>
    <tbody>
    {% for sample in samples %}
    <tr>
        <td>
            {{ sample.bpa_id }}
        </td>
        <td>
            <a href="{% url 'basecontextual:sampledetail' sample.context.pk %}">Sample Context</a>
        </td>
        <td>
            <a href="{% url 'basecontextual:chemicalanalysisdetail' sample.chemical_analysis.pk %}">Chemical Analysis</a>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% if is_paginated %}
<ul class="pagination pagination-centered">
    {% if page_obj.has_previous %}
    <li><a href="?page=1"><<</a></li>
    <li><a href="?page={{ page_obj.previous_page_number }}"><</a></li>
    {% endif %}

    {% for i in paginator.page_range %}
    <li
    {% if page_obj.number == i %} class="active" {% endif %}><a href="?page={{i}}">{{i}}</a></li>
    {% endfor %}

    {% if page_obj.has_next %}
    <li><a href="?page={{ page_obj.next_page_number }}">></a></li>
    <li><a href="?page={{ page_obj.paginator.num_pages }}">>></a></li>
    {% endif %}
</ul>
{% endif %}


<script>
    $(document).ready(function () {
        $(function () {
            $("#samples").tablesorter();
        });
    });
</script>

{% else %}
<h3> No Results </h3>
{% endif %}
    </div>
    </div>
    {% endif %}

{% endblock %}
