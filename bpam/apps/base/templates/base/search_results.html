{% extends "base.html" %}
{% block title %}Search Results {% endblock %}
{% block content %}
{% if search_form %}

    <form  id="search_form" action="" class="form-inline" role="form" method="post">{% csrf_token %}
    <div class="panel panel-default">
        <div class="panel-heading">Search Form - Search All Samples?
             <input name="search_all" type="checkbox" value="search_all" id="search_all">

        </div>
        <div id="search_panel" class="panel-body">
            <input id="add_search_term" type=button value="+" />
            <input id="remove_search_term" value="-" type=button />
            Find samples with
            <input name="search_operator" type="radio" id="op_and" value="and" checked="checked">All</>
            or
            <input class="form-control" name="search_operator" type="radio" id="op_and" value="or">Any</>
            of the matching fields added below:
            <table id="search_terms" class="table  table-bordered table-striped table-condensed">
                    <thead>
                        <th>Search Type</th>
                        <th>Field</th>
                        <th>Value</th>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input name="search_type0" type="radio" id="field0" value="field" checked="checked">Field</>
                                <input class="form-control" name="search_type0" type="radio" id="range0" value="range">Range</>
                            </td>

                            <td>
                                <select id="search_field0" name="search_field0">

                                </select>
                            </td>

                            <td>
                                <select id="search_standardised_value0" name="search_standardised_value0"></select>
                                <input id="search_range_min0" name="search_range_min0"  type=text>
                                <input id="search_range_max0" name="search_range_max0" type=text>
                                <input id="search_value0" name="search_value0" type=text>
                            </td>

                        </tr>
                    </tbody>

                </table>




              </div>



            </div>

            <div class="panel-heading">
               Taxonomic Filter
                 <div class="panel-body">
             <table id="taxonomic_filter_table"  class="table table-bordered table-striped table-condensed">
                    <thead>
                    <th>Level</th>
                    <th>Value</th>
                    </thead>
                   <tbody>
                    <tr>
                        <td>Kingdom</td>
                        <td><input type="text" name="kingdom" id="kingdom"></td>
                    </tr>
                   <tr>
                       <td>Phylum</td><td><input type="text" name="phylum" id="phylum"></td></tr>
                    <tr><td>Class</td><td><input type="text" name="class" id="class"></td></tr>
                    <tr><td>Order</td><td><input type="text" name="order" id="order"></td></tr>
                   <tr><td>Family</td><td><input type="text" name="family" id="family"></td></tr>
                   <tr><td>Genus</td><td><input type="text" name="genus" id="genus"></td></tr>
                   <tr><td>Species</td><td><input type="text" name="species" id="species"></td></tr>

                   </tbody>
               </table>
        </div>
            </div>
            <input id="search_button"  class="btn btn-default" value="Search" />
        </form>
        <script>
        $(document).ready(function() {
            var standardisedVocabularyEndPointURL = "{% url 'base:lookup' None %}".replace("None","");
            const SEARCH_FORM_URL = "{% url 'base:search' %}";
            const STATUS_OK = "success";
            const rangeFieldOptions = [
                {value: "lat",         text: "Latitude"},
                {value: "lon",         text: "Longitude"},
                {value: "depth",       text: "Soil Depth"},
                {value: "elevation",   text: "Elevation (m)"},
                {value: "texture",     text: "Texture"},
                {value: "gravel",      text: "Gravel (%) - ( >2.0 mm)"},
                {value: "course_sand", text: "Course Sand (%) (200-2000 µm)"},
                {value: "fine_sand",   text: "Fine Sand (%) - (20-200 µm)"},
                {value:"sand",         text: "Sand (%)"},
                {value: "silt", text: "Silt (%) (2-20 µm)"},
                {value: "clay", text: "Clay (%) (<2 µm)"},
                {value: "ammonium_nitrogen", text:"Ammonium Nitrogen (mg/Kg)"},
                {value: "nitrate_nitrogen", text:"Nitrate Nitrogen (mg/Kg)"},
                {value: "phosphorus_colwell", text:"Phosphorus Colwell (mg/Kg)"},
                {value: "potassium_colwell", text:"Potassium Colwell (mg/Kg)"},
                {value: "sulphur_colwell", text:"Sulphur (mg/Kg)"},
                {value: "organic_carbon", text:"Organic Carbon (%)"},
                {value: "conductivity", text:"Conductivity (dS/m)"},
                {value: "cacl2_ph", text: "pH Level (CaCl2) (pH)"},
                {value: "h20_ph", text:"pH Level (H2O) (pH)"},
                {value: "dtpa_copper", text:"DTPA Copper (mg/Kg)"},
                {value: "dtpa_iron", text:"DTPA Iron (mg/Kg)"},
                {value: "dtpa_manganese", text:"DTPA Manganese (mg/Kg)"},
                {value: "dtpa_zinc", text:"DTPA Zinc (mg/Kg)"},
                {value: "exc_aluminium", text:"Exc. Aluminium (meq/100g)"},
                {value: "exc_calcium", text:"Exc. Calcium (meq/100g)"},
                {value: "exc_magnesium", text:"Exc. Magnesium (meq/100g)"},
                {value: "exc_potassium", text:"Exc. Potassium (meq/100g)"},
                {value: "exc_sodium", text:"Exc. Sodium (meq/100g)"},
                {value: "boron_hot_cacl2", text:"Boron Hot CaCl2 (mg/Kg)"},
                {value: "total_nitrogen", text:"Total Nitrogen"},
                {value: "total_carbon", text: "Total Carbon"}];

            const fieldFieldOptions =  [
                { value: "sample_id", text:  "Sample Id"},
                { value: "date_sampled", text:  "Date sampled"},
                { value: "lat", text:  "Latitude"},
                { value: "lon", text:  "Longitude"},
                { value: "depth", text:  "Soil Depth"},
                { value: "description", text:  "Description"},
                { value: "current_land_use", text:  "Current land-use"},
                { value: "general_ecological_zone", text:  "General Ecological Zone"},
                { value: "vegetation_type", text:  "Vegetation Type"},
                { value: "vegetation_total_cover", text:  "Vegetation Total cover (%)"},
                { value: "vegetation_dominant_trees", text:  "Vegetation Dom. Trees"},
                { value: "Vegetation Dom. Shrubs", text:  "Vegetation Dom. Shrubs"},
                { value: "Vegetation Dom. Grasses", text:  "Vegetation Dom. Grasses"},
                { value: "elevation", text:  "Elevation (m)"},
                { value: "australian_soil_classification", text:  "Australian Soil Classification"},
                { value: "fao_soil_type", text:  "FAO soil classification"},
                { value: "immediate_previous_land_use", text:  "Immediate Previous Land Use"},
                { value: "agrochemical_additions", text:  "Agrochemical Additions"},
                { value: "tillage", text:  "Tillage"},
                { value: "fire_history", text:  "Fire History"},
                { value: "fire_intensity", text: "Fire Intensity"},
                { value: "environment_events", text:  "Environment Events"},
                { value: "moisture", text:  "Soil moisture (%)"},
                { value: "colour", text:  "Soil Colour"},
                { value: "texture", text:  "Texture"},
                { value: "gravel", text:  "Gravel (%)"},
                { value: "course_sand", text:  "Course Sand (%)"},
                { value: "fine_sand", text:  "Fine Sand (%)"},
                { value: "sand", text:  "Sand (%)"},
                { value: "silt", text:  "Silt (%)"},
                { value: "clay", text:  "Clay (%)"},
                { value: "ammonium_nitrogen", text:  "Ammonium Nitrogen (mg/Kg)"},
                { value: "nitrate_nitrogen", text:  "Nitrate Nitrogen (mg/Kg)"},
                { value: "phosphorus_colwell", text:  "Phosphorus Colwell (mg/Kg)"},
                { value: "potassium_colwell", text:  "Potassium Colwell (mg/Kg)"},
                { value: "sulphur_colwell", text:  "Sulphur (mg/Kg)"},
                { value: "organic_carbon", text:  "Organic Carbon (%)"},
                { value: "conductivity", text:  "Conductivity (dS/m)"},
                { value: "cacl2_ph", text:  "pH Level (CaCl2)"},
                { value: "h20_ph", text:  "pH Level (H2O)"},
                { value: "dtpa_copper", text:  "DTPA Copper (mg/Kg)"},
                { value: "dtpa_iron", text:  "DTPA Iron (mg/Kg)"},
                { value: "dtpa_manganese", text:  "DTPA Manganese (mg/Kg)"},
                { value: "dtpa_zinc", text:  "DTPA Zinc (mg/Kg)"},
                { value: "exc_aluminium", text:  "Exc. Aluminium (meq/100g)"},
                { value: "exc_calcium", text:  "Exc. Calcium (meq/100g)"},
                { value: "exc_magnesium", text:  "Exc. Magnesium (meq/100g)"},
                { value: "exc_potassium", text:  "Exc. Potassium (meq/100g)"},
                { value: "exc_sodium", text:  "Exc. Sodium (meq/100g)"},
                { value: "boron_hot_cacl2", text:  "Boron Hot CaCl2 (mg/Kg)"},
                { value: "total_nitrogen", text:  "Total Nitrogen"},
                { value: "total_carbon", text:  "Total Carbon"}];

            // helper functions

            function enabled(row, fieldId, bool) {
                var fieldSelector = "[id^='" + fieldId + "']"
                if (bool) {
                    $(row).find(fieldSelector).prop("disabled", false);
                    $(row).find(fieldSelector).show();
                }
                else {
                    $(row).find(fieldSelector).prop("disabled", true);
                    $(row).find(fieldSelector).hide();
                }
            }

            var activate = function(row, fieldId) {
                return enabled(row, fieldId, true);
            }
            var deactivate = function(row, fieldId) {
                return enabled(row, fieldId, false);
            }

            function isRangeSearch(row) {
                return $(row).find("[id^=range]").is(":checked");
            }

            function getSearchField(row) {
                return $(row).find("[id^=search_field]");
            }

            function checkStandardised(row, callback) {
                var searchFieldSelect = getSearchField(row);
                var searchField = $(searchFieldSelect).val();
                var url = standardisedVocabularyEndPointURL  + searchField;
                $.get(url, callback);
            }

            // utility extension to easily replace options in select - thanks S.O.
            (function($, window) {
              $.fn.replaceOptions = function(options) {
                var self, $option;

                this.empty();
                self = this;

                $.each(options, function(index, option) {
                  $option = $("<option></option>")
                .attr("value", option.value)
                .text(option.text);
                  self.append($option);
                });
              };
            })(jQuery, window);

            function wireUpAllSamplesSearchCheckBox() {
                $("#search_all").click(function() {
                    $("#search_panel").toggle();
                });
            }

            function updateStandardisedOptions(row, standardisedOptions) {
                if (standardisedOptions.length > 0) {
                    //$(row).find("[id^=search_value]").hide();
                    deactivate(row,"search_value");
                    activate(row, "search_standardised_value");
                    $(row).find("[id^=search_standardised_value]").replaceOptions(standardisedOptions);
                    //$(row).find("[id^=search_standardised_value]").show();
                }

                else {
                      // not standardised , so just show a text entry field

                      //$(row).find("[id^='search_value']").show();
                      activate(row, "search_value");
                      deactivate(row,"search_standardised_value");
                      //$(row).find("[id^='search_standardised_value']").hide();
                }

            }

            function hideOrShowInputs(newRow) {
                // show single field or range ( min and max ) inputs
                var search_field_select = $(newRow).find("[id^=search_field]");
                if (isRangeSearch(newRow)) {
                    // change options to fields where a range search makes sense
                    $(search_field_select).replaceOptions(rangeFieldOptions);
                    // show the range search inputs and hide the single field input
                    activate(newRow, "search_range_min");
                    activate(newRow, "search_range_max");

                    //$(newRow).find("[id^=search_range_min]," +
                    //        "[id^=search_range_max] ").show();

                    deactivate(newRow,"search_value");

                    //$(newRow).find("[id^=search_value]").hide();
                    deactivate(newRow, "search_standardised_value");
                    //$(newRow).find("[id^=search_standardised_value]").hide();
                    }

                else {
                        $(search_field_select).replaceOptions(fieldFieldOptions);
                        deactivate(newRow, "search_range_min");
                        deactivate(newRow, "search_range_max");
                        //$(newRow).find("[id^=search_range_min],[id^=search_range_max] ").hide();

                        checkStandardised(newRow, function(standardisedOptions, status) {
                            if (status == STATUS_OK) {
                                updateStandardisedOptions(newRow, standardisedOptions);
                            }
                            else {
                                // this should show the text box
                                updateStandardisedOptions(newRow,null);
                            }
                        });
                }
            }

            function wireUpSearchFieldSelect(newRow) {
                // if single field search type selected , make the search value field a drop down list for
                        // for terms with a standardised vocabulary, otherwise make it a textbox
                if (!isRangeSearch(newRow)) {
                    $(newRow).find("[id^=search_field]").change(function () {

                        checkStandardised(newRow, function (standardisedOptions, status){
                            if (status == STATUS_OK){
                                updateStandardisedOptions(newRow, standardisedOptions);
                            }
                            else {
                                updateStandardisedOptions(newRow, null);
                            }

                        });

                    });
                }
                else {
                    $(newRow).find("[id^=search_field]").unbind("change");
                }
            }

            function wireUpRadioButtons(newRow) {
                // Make the search type radio swap field options
                $(newRow).find("[name^=search_type]").unbind("change");
                $(newRow).find("[name^=search_type]").change(function () {
                    hideOrShowInputs(newRow);
                    wireUpSearchFieldSelect(newRow);
                });
            }

            function wireUpSearchButton() {
                $("#search_button").click(function () {
                    doSearch();
                })
            }

            function incrementValue(value) {
                var pattern = /^(.*)(\d+)$/;
                var prefix = value.match(pattern)[1];
                var oldNumber = parseInt(value.match(pattern)[2]);
                var newNumber = oldNumber + 1;
                return prefix + newNumber;
            }

            function updateIds(newRow) {
                newRow.find("[id^='search_type']," +
                         "[id^='field']," +
                         "[id^='range']," +
                         "[id^='search_field']," +
                         "[id^='search_value']," +
                         "[id^='search_standardised_value']," +
                         "[id^='search_range_min']," +
                         "[id^='search_range_max']").each(
                            function(i, val) {
                              val.id = incrementValue(val.id);
                              try {
                                val.name = incrementValue(val.name);
                              }
                              catch(err) {};
                            });
            }

            function addSearchTerm() {
                var lastRow = $("#search_terms > tbody > tr:last");
                var newRow = $(lastRow).clone();
                updateIds(newRow);
                wireUpRadioButtons(newRow);
                hideOrShowInputs(newRow);
                wireUpSearchFieldSelect(newRow);
                $(newRow).insertAfter(lastRow);
            }

            function removeSearchTerm() {
                var numRows = $("#search_terms tr").size() -1;
                if (numRows > 1) {
                    $("#search_terms > tbody > tr:last").remove();
                }

            }

            function doSearch() {
                $.post(SEARCH_FORM_URL,
                       $("#search_form").serialize(),
                       displayResults);
            }

            function displayResults(results) {
                // clear table
                $("#results > tbody > tr").remove();

                function link(text,link) {
                    return "<a href='" + link + "'>" + text + "</a>";
                }

                function td(s){
                    return "<td>" + s + "</td>"
                }

                $(results).each(function (index, item) {
                    var new_row = "<tr>" +
                                  td(item.bpa_id) +
                                  td(link("Sample Context",item.sc)) +
                                  td(link("Chemical Analysis",item.ca)) +
                                  td(link("Amplicon",item.am)) +
                                  "</tr>";

                    $("#results > tbody").append(new_row);
                });
            }

            $("#add_search_term").click(addSearchTerm);
            $("#remove_search_term").click(removeSearchTerm);
            // initialise the handlers on the first row also ( not just dynamically added rows)
            var firstRow = $("#search_terms > tbody > tr:first");
            wireUpRadioButtons(firstRow);
            hideOrShowInputs(firstRow);
            wireUpSearchFieldSelect(firstRow);
            wireUpAllSamplesSearchCheckBox();
            wireUpSearchButton();

          });
    </script>
{% endif %}

        <div class="panel panel-default">
        <div class="panel-heading">Results</div>
        <div class="panel-body">


            <table id="results" class="table table-striped tablesorter">
                <thead>
                <tr>
                        <th>BPA ID</th>
                        <th>Sample Context</th>
                        <th>Chemical Analysis</th>
                        <th>Amplicon</th>
                </tr>

    </thead>
    <tbody>


    </tbody>
</table>



<script>
    $(document).ready(function () {
        $(function () {
            $("#samples").tablesorter();
        });
    });
</script>


    </div>
    </div>


{% endblock %}